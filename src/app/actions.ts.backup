  // CrÃ©er le profil candidat si nÃ©cessaire - utilise la fonction de service RLS
  if (user && (userRole === 'candidate' || userRole === 'worker' || userRole === 'staff')) {
    try {
      console.log('ðŸ”„ CrÃ©ation du profil candidat pour:', user.id);
      
      // Attendre un peu pour que l'utilisateur soit bien crÃ©Ã© dans auth.users
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Utiliser la fonction de service pour contourner les problÃ¨mes RLS
      const { data: profileId, error: serviceError } = await supabase
        .rpc('create_candidate_profile_service', {
          p_user_id: user.id,
          p_full_name: fullName || email,
          p_email: email
        });

      if (serviceError) {
        console.error('âŒ Erreur fonction de service:', serviceError);
        
        // Si erreur 23503 (FK) ou 42883 (fonction n'existe pas), essayer la mÃ©thode directe
        if (serviceError.code === '23503' || serviceError.code === '42883' || serviceError.code === '42501') {
          console.log('âš ï¸ Fallback: crÃ©ation directe du profil aprÃ¨s correction des dÃ©pendances');
          
          // D'abord crÃ©er l'entrÃ©e dans users si nÃ©cessaire
          try {
            await supabase
              .from('users')
              .upsert({
                id: user.id,
                user_id: user.id,
                email: email,
                name: fullName || email,
                full_name: fullName || email,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
              }, { onConflict: 'id' });
            
            console.log('âœ… EntrÃ©e users crÃ©Ã©e/mise Ã  jour');
          } catch (userError) {
            console.log('âš ï¸ Erreur crÃ©ation users (peut-Ãªtre dÃ©jÃ  existe):', userError);
          }
          
          // Puis crÃ©er le profil candidat
          const { data: profile, error: directError } = await supabase
            .from('candidate_profiles')
            .upsert({
              user_id: user.id,
              full_name: fullName || email,
              email: email,
              is_available: true,
              skills: [],
              rating: 0
            }, { onConflict: 'user_id' })
            .select()
            .single();

          if (directError) {
            if (directError.code === '23505' || directError.code === '23503') {
              console.log('âœ… Profil candidat existe dÃ©jÃ  ou crÃ©Ã© via contrainte');
            } else {
              throw directError;
            }
          } else {
            console.log('âœ… Profil candidat crÃ©Ã© (mÃ©thode directe):', profile.id);
          }
        } else {
          throw serviceError;
        }
      } else {
        console.log('âœ… Profil candidat crÃ©Ã© via fonction de service:', profileId);
      }
    } catch (err) {
      console.error('âŒ Erreur crÃ©ation profil:', err);
      // Ne pas bloquer l'inscription si la crÃ©ation du profil Ã©choue
      // L'utilisateur pourra crÃ©er son profil lors de la premiÃ¨re connexion
      console.log('âš ï¸ Profil candidat non crÃ©Ã©, mais inscription rÃ©ussie');
    }
  }"use server";

import { encodedRedirect, getLocaleFromFormData } from "../utils/utils";
import { redirect } from "next/navigation";
import { createClient } from "../../supabase/server";

export const signUpAction = async (formData: FormData) => {
  const email = formData.get("email")?.toString();
  const password = formData.get("password")?.toString();
  const fullName = formData.get("full_name")?.toString() || '';
  const userRole = formData.get("user_role")?.toString() || 'company';
  const locale = getLocaleFromFormData(formData);
  const supabase = await createClient();

  if (!email || !password) {
    return encodedRedirect(
      "error",
      `/${locale}/sign-up`,
      "Email and password are required",
    );
  }

  const { data: { user }, error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      data: {
        full_name: fullName,
        email: email,
        role: userRole,
      }
    },
  });

  if (error) {
    // Gestion des erreurs spÃ©cifiques d'inscription
    let errorMessage = error.message;
    
    if (error.message.includes('User already registered') || 
        error.message.includes('already been registered') ||
        error.message.includes('Email address already registered') ||
        error.message.includes('signup_disabled')) {
      errorMessage = locale === 'fr' ? 
        'Cet email est dÃ©jÃ  utilisÃ©. Essayez de vous connecter.' :
        locale === 'ar' ?
        'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„. Ø­Ø§ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.' :
        'This email is already registered. Try signing in.';
    } else if (error.message.includes('Invalid email')) {
      errorMessage = locale === 'fr' ? 
        'Adresse email invalide.' :
        locale === 'ar' ?
        'Ø¹Ù†ÙˆØ§Ù† Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­.' :
        'Invalid email address.';
    } else if (error.message.includes('Password')) {
      errorMessage = locale === 'fr' ? 
        'Le mot de passe doit contenir au moins 6 caractÃ¨res.' :
        locale === 'ar' ?
        'ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.' :
        'Password must be at least 6 characters long.';
    }
    
    return encodedRedirect("error", `/${locale}/sign-up`, errorMessage);
  }

  // VÃ©rifier que l'utilisateur a bien Ã©tÃ© crÃ©Ã©
  if (!user) {
    return encodedRedirect(
      "error", 
      `/${locale}/sign-up`, 
      locale === 'fr' ? 
        'Erreur lors de la crÃ©ation du compte. Veuillez rÃ©essayer.' :
        locale === 'ar' ?
        'Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.' :
        'Error creating account. Please try again.'
    );
  }

  // VÃ©rification critique: si l'utilisateur retournÃ© existe depuis longtemps, c'est un compte existant
  if (user && !user.email_confirmed_at) {
    const createdAt = new Date(user.created_at);
    const now = new Date();
    const timeDiff = now.getTime() - createdAt.getTime();
    
    // Si l'utilisateur a Ã©tÃ© crÃ©Ã© il y a plus de 2 secondes, c'est probablement un compte existant
    if (timeDiff > 2000) { // 2 secondes
      const errorMessage = locale === 'fr' ? 
        'Cet email est dÃ©jÃ  utilisÃ© mais non confirmÃ©. VÃ©rifiez votre boÃ®te email pour confirmer votre compte ou contactez le support.' :
        locale === 'ar' ?
        'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ ÙˆÙ„ÙƒÙ† ØºÙŠØ± Ù…Ø¤ÙƒØ¯. ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„ØªØ£ÙƒÙŠØ¯ Ø­Ø³Ø§Ø¨Ùƒ Ø£Ùˆ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø¯Ø¹Ù….' :
        'This email is already registered but not confirmed. Check your email to confirm your account or contact support.';
      
      return encodedRedirect("error", `/${locale}/sign-up`, errorMessage);
    }
  }

  // Si l'utilisateur existe et est dÃ©jÃ  confirmÃ©, c'est dÃ©finitivement un compte existant
  if (user && user.email_confirmed_at) {
    const errorMessage = locale === 'fr' ? 
      'Cet email est dÃ©jÃ  utilisÃ© et confirmÃ©. Essayez de vous connecter.' :
      locale === 'ar' ?
      'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ ÙˆÙ…Ø¤ÙƒØ¯. Ø­Ø§ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.' :
      'This email is already registered and confirmed. Try signing in.';
    
    return encodedRedirect("error", `/${locale}/sign-up`, errorMessage);
  }

  // CrÃ©er le profil candidat si nÃ©cessaire - utilise la fonction de service RLS
  if (user && (userRole === 'candidate' || userRole === 'worker' || userRole === 'staff')) {
    try {
      console.log('ðŸ”„ CrÃ©ation du profil candidat pour:', user.id);
      
      // Utiliser la fonction de service pour contourner les problÃ¨mes RLS
      const { data: profileId, error: serviceError } = await supabase
        .rpc('create_candidate_profile_service', {
          p_user_id: user.id,
          p_full_name: fullName || email,
          p_email: email
        });

      if (serviceError) {
        console.error('âŒ Erreur fonction de service:', serviceError);
        
        // Si la fonction Ã©choue (peut-Ãªtre n'existe pas encore), essayer l'ancienne mÃ©thode
        console.log('âš ï¸ Fallback: crÃ©ation directe du profil');
        const { data: profile, error: directError } = await supabase
          .from('candidate_profiles')
          .insert({
            user_id: user.id,
            full_name: fullName || email,
            email: email,
            is_available: true,
            skills: [],
            rating: 0
          })
          .select()
          .single();

        if (directError) {
          if (directError.code === '23505') {
            console.log('âœ… Profil candidat existe dÃ©jÃ  (contrainte unique)');
          } else {
            throw directError;
          }
        } else {
          console.log('âœ… Profil candidat crÃ©Ã© (mÃ©thode directe):', profile.id);
        }
      } else {
        console.log('âœ… Profil candidat crÃ©Ã© via fonction de service:', profileId);
      }
    } catch (err) {
      console.error('âŒ Erreur crÃ©ation profil:', err);
      // Ne pas bloquer l'inscription si la crÃ©ation du profil Ã©choue
      // L'utilisateur pourra crÃ©er son profil lors de la premiÃ¨re connexion
      console.log('âš ï¸ Profil candidat non crÃ©Ã©, mais inscription rÃ©ussie');
    }
  }

  // Rediriger vers la page de confirmation d'email avec l'adresse email
  return redirect(`/${locale}/email-confirmation?email=${encodeURIComponent(email)}`);
};

export const signInAction = async (formData: FormData) => {
  const email = formData.get("email") as string;
  const password = formData.get("password") as string;
  const locale = getLocaleFromFormData(formData);
  const supabase = await createClient();

  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  });

  if (error) {
    return encodedRedirect("error", `/${locale}/sign-in`, error.message);
  }

  // Redirection basÃ©e sur le rÃ´le de l'utilisateur
  const userRole = data.user?.user_metadata?.role;
  
  if (userRole === 'staff' || userRole === 'candidate' || userRole === 'worker') {
    return redirect(`/${locale}/dashboard/candidate`);
  }
  
  return redirect(`/${locale}/dashboard`);
};

export const forgotPasswordAction = async (formData: FormData) => {
  const email = formData.get("email")?.toString();
  const supabase = await createClient();
  const callbackUrl = formData.get("callbackUrl")?.toString();
  const locale = getLocaleFromFormData(formData);

  if (!email) {
    return encodedRedirect("error", `/${locale}/forgot-password`, "Email is required");
  }

  const { error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: callbackUrl || `${process.env.NODE_ENV === 'development' ? 'http://localhost:3000' : 'https://tempo-tempo.vercel.app'}/${locale}/auth/callback?redirect_to=/${locale}/protected/reset-password`,
  });

  if (error) {
    console.error(error.message);
    return encodedRedirect(
      "error",
      `/${locale}/forgot-password`,
      "Could not reset password",
    );
  }

  return encodedRedirect(
    "success",
    `/${locale}/forgot-password`,
    "Check your email for a link to reset your password.",
  );
};

export const resetPasswordAction = async (formData: FormData) => {
  const supabase = await createClient();
  const password = formData.get("password") as string;
  const confirmPassword = formData.get("confirmPassword") as string;
  const locale = getLocaleFromFormData(formData);

  if (!password || !confirmPassword) {
    return encodedRedirect(
      "error",
      `/${locale}/dashboard/reset-password`,
      "Password and confirm password are required",
    );
  }

  if (password !== confirmPassword) {
    return encodedRedirect(
      "error",
      `/${locale}/dashboard/reset-password`,
      "Passwords do not match",
    );
  }

  const { error } = await supabase.auth.updateUser({
    password: password,
  });

  if (error) {
    return encodedRedirect(
      "error",
      `/${locale}/dashboard/reset-password`,
      "Password update failed",
    );
  }

  return encodedRedirect("success", `/${locale}/protected/reset-password`, "Password updated");
};

export const signOutAction = async (formData: FormData) => {
  const locale = getLocaleFromFormData(formData);
  const supabase = await createClient();
  await supabase.auth.signOut();
  return redirect(`/${locale}/sign-in`);
};

export const checkUserSubscription = async (userId: string) => {
  const supabase = await createClient();

  const { data: subscription, error } = await supabase
    .from('subscriptions')
    .select('*')
    .eq('user_id', userId)
    .eq('status', 'active')
    .single();

  if (error) {
    console.error('Error checking subscription:', error);
    return null;
  }

  return subscription;
};
