  // Créer le profil candidat si nécessaire - utilise la fonction de service RLS
  if (user && (userRole === 'candidate' || userRole === 'worker' || userRole === 'staff')) {
    try {
      console.log('🔄 Création du profil candidat pour:', user.id);
      
      // Attendre un peu pour que l'utilisateur soit bien créé dans auth.users
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Utiliser la fonction de service pour contourner les problèmes RLS
      const { data: profileId, error: serviceError } = await supabase
        .rpc('create_candidate_profile_service', {
          p_user_id: user.id,
          p_full_name: fullName || email,
          p_email: email
        });

      if (serviceError) {
        console.error('❌ Erreur fonction de service:', serviceError);
        
        // Si erreur 23503 (FK) ou 42883 (fonction n'existe pas), essayer la méthode directe
        if (serviceError.code === '23503' || serviceError.code === '42883' || serviceError.code === '42501') {
          console.log('⚠️ Fallback: création directe du profil après correction des dépendances');
          
          // D'abord créer l'entrée dans users si nécessaire
          try {
            await supabase
              .from('users')
              .upsert({
                id: user.id,
                user_id: user.id,
                email: email,
                name: fullName || email,
                full_name: fullName || email,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
              }, { onConflict: 'id' });
            
            console.log('✅ Entrée users créée/mise à jour');
          } catch (userError) {
            console.log('⚠️ Erreur création users (peut-être déjà existe):', userError);
          }
          
          // Puis créer le profil candidat
          const { data: profile, error: directError } = await supabase
            .from('candidate_profiles')
            .upsert({
              user_id: user.id,
              full_name: fullName || email,
              email: email,
              is_available: true,
              skills: [],
              rating: 0
            }, { onConflict: 'user_id' })
            .select()
            .single();

          if (directError) {
            if (directError.code === '23505' || directError.code === '23503') {
              console.log('✅ Profil candidat existe déjà ou créé via contrainte');
            } else {
              throw directError;
            }
          } else {
            console.log('✅ Profil candidat créé (méthode directe):', profile.id);
          }
        } else {
          throw serviceError;
        }
      } else {
        console.log('✅ Profil candidat créé via fonction de service:', profileId);
      }
    } catch (err) {
      console.error('❌ Erreur création profil:', err);
      // Ne pas bloquer l'inscription si la création du profil échoue
      // L'utilisateur pourra créer son profil lors de la première connexion
      console.log('⚠️ Profil candidat non créé, mais inscription réussie');
    }
  }"use server";

import { encodedRedirect, getLocaleFromFormData } from "../utils/utils";
import { redirect } from "next/navigation";
import { createClient } from "../../supabase/server";

export const signUpAction = async (formData: FormData) => {
  const email = formData.get("email")?.toString();
  const password = formData.get("password")?.toString();
  const fullName = formData.get("full_name")?.toString() || '';
  const userRole = formData.get("user_role")?.toString() || 'company';
  const locale = getLocaleFromFormData(formData);
  const supabase = await createClient();

  if (!email || !password) {
    return encodedRedirect(
      "error",
      `/${locale}/sign-up`,
      "Email and password are required",
    );
  }

  const { data: { user }, error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      data: {
        full_name: fullName,
        email: email,
        role: userRole,
      }
    },
  });

  if (error) {
    // Gestion des erreurs spécifiques d'inscription
    let errorMessage = error.message;
    
    if (error.message.includes('User already registered') || 
        error.message.includes('already been registered') ||
        error.message.includes('Email address already registered') ||
        error.message.includes('signup_disabled')) {
      errorMessage = locale === 'fr' ? 
        'Cet email est déjà utilisé. Essayez de vous connecter.' :
        locale === 'ar' ?
        'هذا البريد الإلكتروني مستخدم بالفعل. حاول تسجيل الدخول.' :
        'This email is already registered. Try signing in.';
    } else if (error.message.includes('Invalid email')) {
      errorMessage = locale === 'fr' ? 
        'Adresse email invalide.' :
        locale === 'ar' ?
        'عنوان بريد إلكتروني غير صالح.' :
        'Invalid email address.';
    } else if (error.message.includes('Password')) {
      errorMessage = locale === 'fr' ? 
        'Le mot de passe doit contenir au moins 6 caractères.' :
        locale === 'ar' ?
        'يجب أن تحتوي كلمة المرور على 6 أحرف على الأقل.' :
        'Password must be at least 6 characters long.';
    }
    
    return encodedRedirect("error", `/${locale}/sign-up`, errorMessage);
  }

  // Vérifier que l'utilisateur a bien été créé
  if (!user) {
    return encodedRedirect(
      "error", 
      `/${locale}/sign-up`, 
      locale === 'fr' ? 
        'Erreur lors de la création du compte. Veuillez réessayer.' :
        locale === 'ar' ?
        'خطأ في إنشاء الحساب. يرجى المحاولة مرة أخرى.' :
        'Error creating account. Please try again.'
    );
  }

  // Vérification critique: si l'utilisateur retourné existe depuis longtemps, c'est un compte existant
  if (user && !user.email_confirmed_at) {
    const createdAt = new Date(user.created_at);
    const now = new Date();
    const timeDiff = now.getTime() - createdAt.getTime();
    
    // Si l'utilisateur a été créé il y a plus de 2 secondes, c'est probablement un compte existant
    if (timeDiff > 2000) { // 2 secondes
      const errorMessage = locale === 'fr' ? 
        'Cet email est déjà utilisé mais non confirmé. Vérifiez votre boîte email pour confirmer votre compte ou contactez le support.' :
        locale === 'ar' ?
        'هذا البريد الإلكتروني مستخدم بالفعل ولكن غير مؤكد. تحقق من صندوق البريد الإلكتروني لتأكيد حسابك أو اتصل بالدعم.' :
        'This email is already registered but not confirmed. Check your email to confirm your account or contact support.';
      
      return encodedRedirect("error", `/${locale}/sign-up`, errorMessage);
    }
  }

  // Si l'utilisateur existe et est déjà confirmé, c'est définitivement un compte existant
  if (user && user.email_confirmed_at) {
    const errorMessage = locale === 'fr' ? 
      'Cet email est déjà utilisé et confirmé. Essayez de vous connecter.' :
      locale === 'ar' ?
      'هذا البريد الإلكتروني مستخدم بالفعل ومؤكد. حاول تسجيل الدخول.' :
      'This email is already registered and confirmed. Try signing in.';
    
    return encodedRedirect("error", `/${locale}/sign-up`, errorMessage);
  }

  // Créer le profil candidat si nécessaire - utilise la fonction de service RLS
  if (user && (userRole === 'candidate' || userRole === 'worker' || userRole === 'staff')) {
    try {
      console.log('🔄 Création du profil candidat pour:', user.id);
      
      // Utiliser la fonction de service pour contourner les problèmes RLS
      const { data: profileId, error: serviceError } = await supabase
        .rpc('create_candidate_profile_service', {
          p_user_id: user.id,
          p_full_name: fullName || email,
          p_email: email
        });

      if (serviceError) {
        console.error('❌ Erreur fonction de service:', serviceError);
        
        // Si la fonction échoue (peut-être n'existe pas encore), essayer l'ancienne méthode
        console.log('⚠️ Fallback: création directe du profil');
        const { data: profile, error: directError } = await supabase
          .from('candidate_profiles')
          .insert({
            user_id: user.id,
            full_name: fullName || email,
            email: email,
            is_available: true,
            skills: [],
            rating: 0
          })
          .select()
          .single();

        if (directError) {
          if (directError.code === '23505') {
            console.log('✅ Profil candidat existe déjà (contrainte unique)');
          } else {
            throw directError;
          }
        } else {
          console.log('✅ Profil candidat créé (méthode directe):', profile.id);
        }
      } else {
        console.log('✅ Profil candidat créé via fonction de service:', profileId);
      }
    } catch (err) {
      console.error('❌ Erreur création profil:', err);
      // Ne pas bloquer l'inscription si la création du profil échoue
      // L'utilisateur pourra créer son profil lors de la première connexion
      console.log('⚠️ Profil candidat non créé, mais inscription réussie');
    }
  }

  // Rediriger vers la page de confirmation d'email avec l'adresse email
  return redirect(`/${locale}/email-confirmation?email=${encodeURIComponent(email)}`);
};

export const signInAction = async (formData: FormData) => {
  const email = formData.get("email") as string;
  const password = formData.get("password") as string;
  const locale = getLocaleFromFormData(formData);
  const supabase = await createClient();

  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  });

  if (error) {
    return encodedRedirect("error", `/${locale}/sign-in`, error.message);
  }

  // Redirection basée sur le rôle de l'utilisateur
  const userRole = data.user?.user_metadata?.role;
  
  if (userRole === 'staff' || userRole === 'candidate' || userRole === 'worker') {
    return redirect(`/${locale}/dashboard/candidate`);
  }
  
  return redirect(`/${locale}/dashboard`);
};

export const forgotPasswordAction = async (formData: FormData) => {
  const email = formData.get("email")?.toString();
  const supabase = await createClient();
  const callbackUrl = formData.get("callbackUrl")?.toString();
  const locale = getLocaleFromFormData(formData);

  if (!email) {
    return encodedRedirect("error", `/${locale}/forgot-password`, "Email is required");
  }

  const { error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: callbackUrl || `${process.env.NODE_ENV === 'development' ? 'http://localhost:3000' : 'https://tempo-tempo.vercel.app'}/${locale}/auth/callback?redirect_to=/${locale}/protected/reset-password`,
  });

  if (error) {
    console.error(error.message);
    return encodedRedirect(
      "error",
      `/${locale}/forgot-password`,
      "Could not reset password",
    );
  }

  return encodedRedirect(
    "success",
    `/${locale}/forgot-password`,
    "Check your email for a link to reset your password.",
  );
};

export const resetPasswordAction = async (formData: FormData) => {
  const supabase = await createClient();
  const password = formData.get("password") as string;
  const confirmPassword = formData.get("confirmPassword") as string;
  const locale = getLocaleFromFormData(formData);

  if (!password || !confirmPassword) {
    return encodedRedirect(
      "error",
      `/${locale}/dashboard/reset-password`,
      "Password and confirm password are required",
    );
  }

  if (password !== confirmPassword) {
    return encodedRedirect(
      "error",
      `/${locale}/dashboard/reset-password`,
      "Passwords do not match",
    );
  }

  const { error } = await supabase.auth.updateUser({
    password: password,
  });

  if (error) {
    return encodedRedirect(
      "error",
      `/${locale}/dashboard/reset-password`,
      "Password update failed",
    );
  }

  return encodedRedirect("success", `/${locale}/protected/reset-password`, "Password updated");
};

export const signOutAction = async (formData: FormData) => {
  const locale = getLocaleFromFormData(formData);
  const supabase = await createClient();
  await supabase.auth.signOut();
  return redirect(`/${locale}/sign-in`);
};

export const checkUserSubscription = async (userId: string) => {
  const supabase = await createClient();

  const { data: subscription, error } = await supabase
    .from('subscriptions')
    .select('*')
    .eq('user_id', userId)
    .eq('status', 'active')
    .single();

  if (error) {
    console.error('Error checking subscription:', error);
    return null;
  }

  return subscription;
};
